# 反悔贪心

假设问题没有限制, 贪心选择最优解. 但是考虑限制情况下, 假设能够确定决策顺序, 若当前的决策不能导向最优解便撤销之前的决策, 进而达到全局最优解.

## 简单例子

[P4053 [JSOI2007] 建筑抢修](https://www.luogu.com.cn/problem/P4053)

模板. 因为截止时间越晚的, 其可操作的时间区间就越大 (且是覆盖). 所以可以考虑按截止时间从小到大枚举. 每次若当前不能取到最优解, 就在已经贪心选择的集合中试着替换 (因为截至时间更晚所以可以替换), 并且最终达到最优.

[P4823 [TJOI2013] 拯救小矮人](https://www.luogu.com.cn/problem/P4823)

有一定转换. 把题目中的条件改为 $(\sum\limits_{others}a)+(a_i+b_i)$ 就能看出来, 总身高越高越晚选择, 因为在后面可以进行替换身高更矮的 (反悔操作).

## 不那么显然的例子

[CF865D Buy Low Sell High](https://www.luogu.com.cn/problem/CF865D)

反悔操作是好进行的. 在值域上考虑, 因为当前价格进行操作无关之前价格的顺序. 有两种情况: 第一类是选择一个未买入的点构成区间, 当前点作为右端点, 之前为左端点. 第二类是选择之前一个区间进行扩充, 这里等效为将之前的右端点视作左端点并且将其释放. 释放后要重新考虑, 也许会觉得很麻烦. 所以操作顺序再次很难决定. 不过发现: 对于当前点, 肯定是贪心选择最小的两类点, 当选择第二类点时其左端必定没有能够供其重新形成区间的两类点. 因此就不用考虑这个点重新连接. 所以只要将两类点作为决策集合就好了.

## 一定的进阶
[P1484 种树](https://www.luogu.com.cn/problem/P1484)

此前先介绍**反悔自动机**概念.

> 同反悔贪心的基本定义, 如果有一种技术能够将非最优解自动进行反悔并回到最优解, 就构成反悔自动机. 可见反悔自动机的反悔技术是最关键的, 具体取决于反悔的替换操作和操作顺序.

这个题目需要先推一些性质. 首先贪心选择大的, 会对周围两个产生约束. 发现选择一个约束仅局限在半径为 1 的区间, 不妨考虑在 $a_2a_3a_4$ 中选择 最大的 $a_3$ . 有点类似邻项交换的感觉, 考虑两件事: 内部贡献, 内部对外部影响. 发现只有两种情况最优:

1. 选择 $a_3$
2. 选择 $a_2a_4$

否则, 如果只选 $a_2a_4$ 一个不如选择 $a_3$, 因为这不会对外面造成约束还最大化自身贡献.

这启示我们从大到小枚举每个点, 并且将邻项缩为一点, 限制就是这个邻项罢了. 同时发现这个缩点过程是可以迭代的, 就是假设缩了一边之后直接缩第二次是没有影响的, 因为在堆内的只是增加量. 这个过程涉及到多次缩点, 而且只用访问前后项, 因此用链表维护.

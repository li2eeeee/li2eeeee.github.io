# 反悔贪心

假设问题没有限制, 贪心选择最优解. 但是考虑限制情况下, 假设能够确定决策顺序, 若当前的决策不能导向最优解便撤销之前的决策, 进而达到全局最优解.

## 简单例子

[P4053 [JSOI2007] 建筑抢修](https://www.luogu.com.cn/problem/P4053)

> 先介绍反悔堆的概念. 把决策放入堆, 每次和堆中最值比较, 可以直观地进行反悔操作.

> 反悔堆的操作顺序一般比较显然, 从操作空间能覆盖的角度考虑.

模板. 因为截止时间越晚的, 其可操作的时间区间就越大 (且是覆盖). 所以可以考虑按截止时间从小到大枚举. 每次若当前不能取到最优解, 就在已经贪心选择的集合中试着替换 (因为截至时间更晚所以可以替换), 并且最终达到最优.

[P4823 [TJOI2013] 拯救小矮人](https://www.luogu.com.cn/problem/P4823)

有一定转换. 把题目中的条件改为 $(\sum\limits_{others}a)+(a_i+b_i)$ 就能看出来, 总身高越高越晚选择, 因为在后面可以进行替换身高更矮的 (反悔操作).

## 不那么显然的例子

[CF865D Buy Low Sell High](https://www.luogu.com.cn/problem/CF865D)

反悔操作是好进行的. 在值域上考虑, 因为当前价格进行操作无关之前价格的顺序. 有两种情况: 第一类是选择一个未买入的点构成区间, 当前点作为右端点, 之前为左端点. 第二类是选择之前一个区间进行扩充, 这里等效为将之前的右端点视作左端点并且将其释放. 释放后要重新考虑, 也许会觉得很麻烦. 所以操作顺序再次很难决定. 不过发现: 对于当前点, 肯定是贪心选择最小的两类点, 当选择第二类点时其左端必定没有能够供其重新形成区间的两类点. 因此就不用考虑这个点重新连接. 所以只要将两类点作为决策集合就好了. 

> 本质上是反悔自动机而非反悔堆, 反悔自动机和反悔堆的主要区别在于反悔堆直接维护决策集合, 是一种简单的反悔自动机.


## 一定的进阶
[P1484 种树](https://www.luogu.com.cn/problem/P1484)

此前先介绍**反悔自动机**概念.

**同反悔贪心的基本定义, 如果有一种技术能够将非最优解自动进行反悔并回到最优解, 就构成反悔自动机. 可见反悔自动机的反悔技术是最关键的, 具体取决于反悔的替换操作和操作顺序. 并且感觉上, 反悔自动机都是在所选答案大小集合不减地考虑, 只有这样才能比较加入答案的代价或者调整当前局面更优.**

按照上面思路, 优先选择大的点, 但是但出现问题: 对相邻节点有限制. 那假设需要反悔, 不想选择之前选择过的大的, 就势必会选择原本的两边小节点. 直观上而言就是说, 如果不想选这个大的, 肯定不能只选择一个两边小的, 否则不忧. 证明如下:

发现选择一个约束仅局限在半径为 1 的区间, 不妨考虑在 $a_2a_3a_4$ 中选择 最大的 $a_3$ . 有点类似邻项交换的感觉, 考虑两件事: 内部贡献, 内部对外部影响. 发现只有两种情况最优

1. 选择 $a_3$
2. 选择 $a_2a_4$

否则, 如果只选 $a_2a_4$ 一个不如选择 $a_3$, 因为这不会对外面造成约束还最大化自身贡献.

这启示我们从大到小枚举每个点, 并且将邻项缩为一点, 限制就是这个邻项罢了. 选择这个项贡献为答案 +1, 和一般的一样.同时发现这个缩点过程是可以迭代的, 就是假设缩了一边之后直接缩第二次是没有影响的, 因为在堆内的只是增加量. 这个过程涉及到多次缩点, 而且只用访问前后项, 因此用链表维护.

[P1792 [国家集训队] 种树](https://www.luogu.com.cn/problem/P1792)

和上面几乎一样, 把链表改为循环同时对次数要求严格一点. 但依旧可以反悔贪心.

> 从上面两个例子可以看出, 反悔自动机的设计最基本的要求是反悔操作不能有影响的复杂传递, 否则无法在简单进行反悔. 具体而言, 在 CF865D 中, 如果将之前的右端点作为当前的左端点, 那么之前的右端点不能重新贡献答案; 在 P1484 中, 反悔不选择某个点实际上已经包括了传递操作, 因为缩点新的权重是差分信息, 比如 8 10 9 中, 选择 10 然后将 8 9 缩为一点, 点权为 7, 当加入缩的这个点会令答案 + 7, 如果外面又给缩的点再次反悔, 比如 x 8 10 9 要选择 x, 那么此时的反悔操作只会让 + 7 的差分减掉, 保留了内部的 + 10, 自动传递 "不选择 8 9" 的影响.

> 同时不要把反悔贪心和贪心割裂了, 依旧和操作顺序相关

[P3045 [USACO12FEB] Cow Coupons G](https://www.luogu.com.cn/problem/P3045)

练习. 直接维护决策集合不可行, 考虑反悔自动机. 假设有两个集合, 分别是原价买入和优惠买入. 依照题意, 优惠买入最多有 k 个, 并且两个集合总的钱数不超过 m. 于是答案一定有 k 个优惠买入, 或者就是在最优惠的 k 个里面从低到高选择. 于是先将这些低 k 的都选入优惠买入. 考虑其他物品:

1. 原价买入
2. 优惠买入, 但是为保持 k, 原本优惠买入就要弹出考虑.

直观的理解是作为 1 的应该是原价最小的, 作为 2 应该是优惠价格最小的. 用两个堆表示剩余原价和优惠价格, 每次先取最小的, 用堆顶进行操作一定最优. 然后考虑 2 中弹出的, 这个要么被删除 (此时相当违背了操作的优先级, 不考虑), 要么原价买入. 重点考虑操作 2 原价买入原本优惠买入, 代价为 $c_i+p_j-c_j$. 操作 1 和操作 2 的比较就是 $p_t$ 和 $c_i+p_j-c_j$的 比较. 如果选择操作2, 那么说明直接原价买入1都不如这样修改. 就不必 "弹出物品原价买入是否最优" 的问题. 如果都买不了,  之后如何修改也不能增加了. 就直接结束.

类似题, 再来一道

[CF730I Olympiad in Programming and Sports](https://www.luogu.com.cn/problem/CF730I)

题目中的限制变了. 但仍然比较类似. 先考虑把最大 p 个的 $a_i$ 都选进来.
发现如果要这最大编程组发生变化, 就是要用一个人替换, 然后让这些最大点去做体育.
那这就和上面很相似了.
